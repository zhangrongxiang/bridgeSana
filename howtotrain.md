我将为您详细介绍Vision Bridge Transformer (ViBT)的特点，特别是其data-to-data范式，以及图像模型的训练过程和公式。

## ViBT 核心特点：Data-to-Data 范式

### 与传统扩散模型的本质区别

| 特性 | 传统扩散模型 (Noise-to-Data) | ViBT Bridge模型 (Data-to-Data) |
|:---|:---|:---|
| **生成起点** | 随机高斯噪声 | 结构化源数据（源图像/视频） |
| **生成轨迹** | 噪声 → 数据 | 源数据 → 目标数据 |
| **适用场景** | 无条件/文本条件生成 | 图像编辑、视频翻译、风格迁移等 |
| **条件引入** | 需额外编码器/交叉注意力 | 直接作为端点嵌入桥接过程 |
| **计算效率** | 需要额外条件分支 | 无需额外条件编码，效率更高 |

### Data-to-Data 的核心优势

1. **更自然的条件生成**：在图像编辑中，源图像与目标图像往往高度相似，直接从源到目标比从噪声恢复更直观
2. **结构保持**：Brownian Bridge 的数学特性确保两端点约束，更好地保持源内容结构
3. **计算高效**：省去额外的条件编码分支，减少约 **50% 的token数量**（见论文 Table S1）

---

## 图像模型训练过程与公式详解

### 1. 基础数学框架：Brownian Bridge

给定源图像 latent $x_0 \sim p_{\text{source}}$ 和目标图像 latent $x_1 \sim p_{\text{target}}$，Brownian Bridge 定义随机微分方程（SDE）：

$$\mathrm{d}X_t = v(X_t, t)\mathrm{d}t + \sigma(t)\mathrm{d}W_t, \quad t \in [0,1]$$

边界条件：$X_0 = x_0$, $X_1 = x_1$

### 2. 关键公式推导

#### (1) 中间状态采样公式

给定时间 $t \in [0,1]$ 和随机噪声 $\epsilon \sim \mathcal{N}(0, I)$，中间状态 $x_t$ 构造为：

$$\boxed{x_t = (1-t)x_0 + t x_1 + \sqrt{t(1-t)} \cdot \epsilon}$$

**各项含义：**
- $(1-t)x_0 + t x_1$：从源到目标的**线性插值**（确定性路径）
- $\sqrt{t(1-t)} \cdot \epsilon$：Brownian Bridge 的**随机扰动**
- $t(1-t)$：方差在 $t=0.5$ 时最大，两端点为0

#### (2) 速度场目标（原始形式）

根据SDE理论，条件速度场目标为：

$$u_t(x_t | x_1) = \frac{x_1 - x_1}{1-t} = (x_1 - x_0) - \sqrt{\frac{t}{1-t}} \cdot \epsilon$$

**问题**：当 $t \to 1$ 时，第二项 $\sqrt{\frac{t}{1-t}} \epsilon$ **发散**，导致数值不稳定。

---

### 3. 核心创新：Stabilized Velocity Matching

#### (3) 归一化因子 $\alpha$

为解决数值不稳定，ViBT提出**方差稳定化的速度匹配目标**。定义归一化因子：

$$\boxed{\alpha(x_0, x_1, t)^2 = 1 + \frac{t \cdot D}{(1-t)\|x_1 - x_0\|^2}}$$

其中 $D$ 为 latent 维度数。

**推导逻辑**（见论文第4页和补充材料C）：
- 计算条件期望：$\mathbb{E}_\epsilon[\|u_t(x_t|x_1)\|^2] = \|x_1-x_0\|^2 + \frac{t}{1-t}D$
- 归一化使得目标速度的幅度与 $\|x_1-x_0\|$ 相当

#### (4) 稳定化速度目标

$$\boxed{\tilde{u}_t(x_t | x_1) = \frac{u_t(x_t | x_1)}{\alpha(x_0, x_1, t)}}$$

#### (5) 最终训练损失函数

$$\boxed{\mathcal{L}_{\tilde{velocity}} = \mathbb{E}_{t,\epsilon,x_0,x_1}\left[\left\|\tilde{v}_\theta(x_t, t) - \tilde{u}_t(x_t|x_1)\right\|^2\right]}$$

**注意**：网络仍直接预测原始速度 $v_\theta(x_t, t)$，仅在计算loss时进行归一化：
$$\tilde{v}_\theta(x_t, t) = \frac{v_\theta(x_t, t)}{\alpha(x_0, x_1, t)}$$

---

### 4. 图像模型完整训练算法

**输入**：图像对 $(x_0, x_1) \sim p_{\text{source,target}}$，模型 $v_\theta$，latent维度 $D$

```
算法：ViBT 图像模型训练
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. repeat
2.   采样：图像latent对 (x₀, x₁)，时间 t ~ U(0,1)，噪声 ε ~ N(0,I)
3.   
4.   构造中间状态：
5.      xₜ = (1-t)·x₀ + t·x₁ + √[t(1-t)] · ε
6.   
7.   计算速度目标：
8.      uₜ = (x₁ - xₜ) / (1-t)
9.   
10.  计算归一化因子：
11.     α² = 1 + [t·D] / [(1-t)·‖x₁-x₀‖²]
12.  
13.  计算稳定化速度损失：
14.     L = ‖ vθ(xₜ,t)/α  −  uₜ/α ‖²
15.  
16.  梯度下降更新参数 θ
17. until convergence
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 5. 图像模型推理（采样）算法

**输入**：源图像latent $x_0$，目标图像latent $x_1$（或仅文本指令），训练好的模型 $v_\theta$，步数 $N$

```
算法：ViBT 图像模型推理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 初始化：x ← x₀
2. for k = 0, 1, ..., N-1 do:
3.   计算步长：Δt ← t_{k+1} - t_k
4.   
5.   计算方差校正因子（关键！）：
6.      η ← √( Δt · (1-t_{k+1})/(1-t_k) )
7.   
8.   采样噪声：ε ~ N(0, I)
9.   
10.  更新latent状态（Euler-Maruyama + 方差校正）：
11.     x ← x + Δt·vθ(x, t_k) + η·ε
12.      
13. end for
14. 输出：最终状态 x ≈ x₁
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**方差校正的关键作用**：确保噪声幅度随 $t \to 1$ 衰减至0，匹配Brownian Bridge的边界约束。

---

## 图像模型具体配置（论文第5节）

| 配置项 | 参数 |
|:---|:---|
| **基础模型** | Qwen-Image-Editing (20B参数) |
| **训练方式** | LoRA微调，rank=128 |
| **优化器** | Prodigy (自适应学习率，lr=1) |
| **训练迭代** | 20,000 iterations |
| **批次大小** | 1 (单卡a100) |
| **分辨率支持** | 1024×1024, 1328×1328, 1664×928等多种宽高比 |
| **数据集规模** | ~5,940 图像对 (Open Images + 合成数据) |

### 关键超参数：噪声尺度 $s$

通过扩展SDE引入全局噪声参数：
$$\mathrm{d}X_t = v_\theta(X_t,t)\mathrm{d}t + s \cdot \mathrm{d}W_t$$

| 噪声尺度 $s$ | 效果 |
|:---|:---|
| $s=0$ | 确定性生成（如Rectified Flow）|
| $s=0.5$ | **图像编辑最佳**（论文Table 6）|
| $s=1$ | 默认平衡设置 |
| $s=2$ | 更多随机性，深度到视频任务表现好 |
| $s>4$ | 质量显著下降 |

---

## 总结图：训练与推理流程

```
训练阶段：                    推理阶段：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

源图像 x₀ ──┐                                源图像 x₀ ──┐
           ├──→ 构造 xₜ ──→ 预测 vθ ──→ 损失 │            │
目标图像 x₁ ──┘    ↑_________↓               │            ├──→ Bridge扩散 ──→ 编辑后图像
     ↑                                       │        (N步采样)      ↑
文本指令 ─────→ Qwen-VL生成编辑 ──────────────┘            文本指令 ───┘
 (数据集构建)
```

ViBT通过**稳定化速度匹配目标**和**方差校正采样**，成功将Brownian Bridge模型扩展到20B参数规模，在保持计算效率的同时，实现了高质量的指令式图像编辑能力。